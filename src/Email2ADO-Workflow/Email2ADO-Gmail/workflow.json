{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "2.1.1.0",
    "actions": {
      "Initialize_MessageId": {
        "type": "InitializeVariable",
        "runAfter": {},
        "inputs": {
          "variables": [
            {
              "name": "MessageId",
              "type": "string",
              "value": "@triggerBody()?['Id']"
            }
          ]
        },
        "description": "Gmail Message ID ì¶”ì¶œ"
      },
      "Initialize_Subject": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_MessageId": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Subject",
              "type": "string",
              "value": "@coalesce(triggerBody()?['Subject'], '(ì œëª© ì—†ìŒ)')"
            }
          ]
        },
        "description": "Gmail ì´ë©”ì¼ ì œëª© ì¶”ì¶œ (null ë°©ì§€)"
      },
      "Initialize_Body": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Subject": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Body",
              "type": "string",
              "value": "@{coalesce(triggerBody()?['Body'], triggerBody()?['Snippet'], '(ë³¸ë¬¸ ì—†ìŒ)')}"
            }
          ]
        },
        "description": "Gmail ë³¸ë¬¸ ì¶”ì¶œ (Body ë˜ëŠ” Snippet)"
      },
      "Initialize_ReceivedTimeKST": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Body": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "ReceivedTimeKST",
              "type": "string",
              "value": "@{addHours(coalesce(triggerBody()?['DateTimeReceived'], utcNow()), 9)}"
            }
          ]
        },
        "description": "ìˆ˜ì‹  ì‹œê°„ KST ë³€í™˜ (+9ì‹œê°„)"
      },
      "Initialize_SenderEmail": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_ReceivedTimeKST": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "SenderEmail",
              "type": "string",
              "value": "@coalesce(triggerBody()?['From'], 'unknown@unknown.com')"
            }
          ]
        },
        "description": "Gmail ë°œì‹ ì ì´ë©”ì¼ ì¶”ì¶œ"
      },
      "Initialize_RecipientEmail": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_SenderEmail": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "RecipientEmail",
              "type": "string",
              "value": "@{if(empty(triggerBody()?['Cc']), coalesce(triggerBody()?['To'], ''), concat(coalesce(triggerBody()?['To'], ''), '; ', triggerBody()?['Cc']))}"
            }
          ]
        },
        "description": "ìˆ˜ì‹ ì ëª©ë¡ (To + Cc)"
      },
      "Initialize_AIAnalysisResult": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_RecipientEmail": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "AIAnalysisResult",
              "type": "string",
              "value": ""
            }
          ]
        },
        "description": "AI ë¶„ì„ ê²°ê³¼ ì €ì¥ìš© ë³€ìˆ˜"
      },
      "Initialize_Tags": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_AIAnalysisResult": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Tags",
              "type": "string",
              "value": "@{if(or(contains(variables('RecipientEmail'), '@'), contains(variables('RecipientEmail'), ';')), 'Email2ADO; Gmail', 'Email2ADO')}"
            }
          ]
        },
        "description": "Work Item íƒœê·¸ ì„¤ì •"
      },
      "Initialize_WorkItemId": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Tags": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "WorkItemId",
              "type": "integer",
              "value": 0
            }
          ]
        },
        "description": "ìƒì„±ëœ Work Item ID ì €ì¥ìš©"
      },
      "Initialize_ErrorMessage": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_WorkItemId": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "ErrorMessage",
              "type": "string",
              "value": ""
            }
          ]
        },
        "description": "ì—ëŸ¬ ë©”ì‹œì§€ ì €ì¥ìš© (Operational Excellence - ê°€ì‹œì„±)"
      },
      "Scope_Duplicate_Check": {
        "type": "Scope",
        "runAfter": {
          "Initialize_ErrorMessage": ["Succeeded"]
        },
        "actions": {
          "Check_MessageId_In_TableStorage": {
            "type": "Http",
            "runAfter": {},
            "inputs": {
              "method": "GET",
              "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails(PartitionKey='@{formatDateTime(utcNow(), 'yyyy-MM')}',RowKey='@{encodeURIComponent(variables('MessageId'))}')",
              "headers": {
                "x-ms-version": "2020-12-06",
                "Accept": "application/json;odata=nometadata"
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://storage.azure.com/"
              },
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT5S",
                "maximumInterval": "PT30S",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "Table Storageì—ì„œ ì¤‘ë³µ ë©”ì¼ í™•ì¸ (Reliability - Retry Policy ì ìš©)"
          },
          "Condition_Is_Duplicate": {
            "type": "If",
            "runAfter": {
              "Check_MessageId_In_TableStorage": ["Succeeded", "Failed"]
            },
            "expression": {
              "and": [
                {
                  "equals": [
                    "@outputs('Check_MessageId_In_TableStorage')['statusCode']",
                    200
                  ]
                }
              ]
            },
            "actions": {
              "Log_Duplicate_Detected": {
                "type": "Compose",
                "runAfter": {},
                "inputs": {
                  "event": "DuplicateEmailDetected",
                  "messageId": "@variables('MessageId')",
                  "subject": "@variables('Subject')",
                  "timestamp": "@utcNow()",
                  "action": "Skipped"
                },
                "description": "ì¤‘ë³µ ê°ì§€ ë¡œê¹… (Operational Excellence - ê´€ì¸¡ì„±)"
              },
              "Terminate_Duplicate": {
                "type": "Terminate",
                "runAfter": {
                  "Log_Duplicate_Detected": ["Succeeded"]
                },
                "inputs": {
                  "runStatus": "Succeeded"
                },
                "description": "ì¤‘ë³µ ë©”ì¼ ì •ìƒ ì¢…ë£Œ"
              }
            },
            "else": {
              "actions": {}
            },
            "description": "ì¤‘ë³µ ì—¬ë¶€ ë¶„ê¸° ì²˜ë¦¬"
          }
        },
        "description": "ğŸ” ì¤‘ë³µ ì²´í¬ Scope - Reliability ì›ì¹™ ì ìš©"
      },
      "Scope_Core_Processing": {
        "type": "Scope",
        "runAfter": {
          "Scope_Duplicate_Check": ["Succeeded"]
        },
        "actions": {
          "Insert_MessageId_To_TableStorage": {
            "type": "Http",
            "runAfter": {},
            "inputs": {
              "method": "POST",
              "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails",
              "headers": {
                "Content-Type": "application/json",
                "Accept": "application/json;odata=nometadata",
                "x-ms-version": "2020-12-06"
              },
              "body": {
                "PartitionKey": "@{formatDateTime(utcNow(), 'yyyy-MM')}",
                "RowKey": "@{variables('MessageId')}",
                "Subject": "@{variables('Subject')}",
                "ReceivedTimeKST": "@{variables('ReceivedTimeKST')}",
                "SenderEmail": "@{variables('SenderEmail')}",
                "ProcessedTime": "@{utcNow()}",
                "Source": "Gmail",
                "Status": "Processing"
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://storage.azure.com/"
              },
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT5S",
                "maximumInterval": "PT30S",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "ë©”ì¼ ID ë“±ë¡ (ì²˜ë¦¬ ì‹œì‘)"
          },
          "Analyze_Email_With_AI": {
            "type": "ServiceProvider",
            "runAfter": {
              "Insert_MessageId_To_TableStorage": ["Succeeded"]
            },
            "inputs": {
              "serviceProviderConfiguration": {
                "connectionName": "azureOpenAI",
                "operationId": "getChatCompletions",
                "serviceProviderId": "/serviceProviders/openai"
              },
              "parameters": {
                "deploymentId": "@appsetting('AZURE_OPENAI_DEPLOYMENT_NAME')",
                "messages": [
                  {
                    "role": "system",
                    "content": "ë‹¹ì‹ ì€ ê¸°ì—… ì´ë©”ì¼ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìˆ˜ì‹ ëœ ì´ë©”ì¼ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:\n\n## ğŸ“œ ìš”ì•½\n(ë©”ì¼ í•µì‹¬ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½)\n\n## ğŸ’¡ ì¸ì‚¬ì´íŠ¸\n(ì´ ë©”ì¼ì´ ì˜ë¯¸í•˜ëŠ” ë°”, ì¤‘ìš”ë„, ê´€ë ¨ ë§¥ë½ ë¶„ì„)\n\n## âœ” ì•¡ì…˜ ì•„ì´í…œ\n(ìˆ˜ì‹ ìê°€ ì·¨í•´ì•¼ í•  êµ¬ì²´ì ì¸ ì¡°ì¹˜ ì‚¬í•­ì„ ë²ˆí˜¸ ëª©ë¡ìœ¼ë¡œ)\n\ní•œê¸€ë¡œ ì‘ë‹µí•˜ê³ , ê°„ê²°í•˜ë©´ì„œë„ ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”."
                  },
                  {
                    "role": "user",
                    "content": "ë‹¤ìŒ ì´ë©”ì¼ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\në°œì‹ ì: @{variables('SenderEmail')}\nì œëª©: @{variables('Subject')}\n\në³¸ë¬¸:\n@{variables('Body')}"
                  }
                ],
                "temperature": 0.3,
                "max_tokens": 1000
              }
            },
            "description": "Azure OpenAI (GPT-4o) ì´ë©”ì¼ ë¶„ì„"
          },
          "Set_AI_Analysis_Result": {
            "type": "SetVariable",
            "runAfter": {
              "Analyze_Email_With_AI": ["Succeeded"]
            },
            "inputs": {
              "name": "AIAnalysisResult",
              "value": "@{coalesce(body('Analyze_Email_With_AI')?['content'], '(AI ë¶„ì„ ê²°ê³¼ ì—†ìŒ)')}"
            },
            "description": "AI ë¶„ì„ ê²°ê³¼ ì €ì¥"
          },
          "Create_ADO_WorkItem": {
            "type": "ApiConnection",
            "runAfter": {
              "Set_AI_Analysis_Result": ["Succeeded"]
            },
            "inputs": {
              "host": {
                "connection": {
                  "referenceName": "visualstudioteamservices"
                }
              },
              "method": "patch",
              "path": "/@{encodeURIComponent(appsetting('ADO_PROJECT'))}/_apis/wit/workitems/$@{encodeURIComponent('Issue')}",
              "queries": {
                "account": "@{appsetting('ADO_ORGANIZATION')}"
              },
              "body": {
                "title": "@{variables('Subject')}",
                "description": "<h2>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h2><div style='background-color:#f0f7ff;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #0078d4;'>@{replace(replace(variables('AIAnalysisResult'), '\n', '<br/>'), '## ', '<h4 style=\"color:#0078d4;margin-top:10px;\">')}</div><hr style='border:1px solid #ddd;margin:20px 0;'/><h2>ğŸ“§ ì›ë³¸ ë©”ì¼ ì •ë³´</h2><table style='width:100%;border-collapse:collapse;margin-bottom:15px;'><tr style='background:#f5f5f5;'><td style='padding:8px;border:1px solid #ddd;width:100px;'><strong>ë°œì‹ ì</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{variables('SenderEmail')}</td></tr><tr><td style='padding:8px;border:1px solid #ddd;'><strong>ìˆ˜ì‹ ì</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{variables('RecipientEmail')}</td></tr><tr style='background:#f5f5f5;'><td style='padding:8px;border:1px solid #ddd;'><strong>ìˆ˜ì‹  ì‹œê°„</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{formatDateTime(variables('ReceivedTimeKST'), 'yyyy-MM-dd HH:mm:ss')} (KST)</td></tr><tr><td style='padding:8px;border:1px solid #ddd;'><strong>ì†ŒìŠ¤</strong></td><td style='padding:8px;border:1px solid #ddd;'>ğŸ“§ Gmail</td></tr></table><h3>ğŸ“ ë³¸ë¬¸ ë‚´ìš©</h3><div style='background:#fafafa;padding:15px;border-radius:8px;border:1px solid #eee;white-space:pre-wrap;font-family:inherit;'>@{first(split(variables('Body'), '________________________________'))}</div>"
              },
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT10S",
                "maximumInterval": "PT1M",
                "minimumInterval": "PT5S"
              }
            },
            "description": "ADO Issue Work Item ìƒì„±"
          },
          "Set_WorkItemId": {
            "type": "SetVariable",
            "runAfter": {
              "Create_ADO_WorkItem": ["Succeeded"]
            },
            "inputs": {
              "name": "WorkItemId",
              "value": "@body('Create_ADO_WorkItem')?['id']"
            },
            "description": "ìƒì„±ëœ Work Item ID ì €ì¥"
          },
          "Update_ADO_WorkItem_Fields": {
            "type": "Http",
            "runAfter": {
              "Set_WorkItemId": ["Succeeded"]
            },
            "inputs": {
              "method": "PATCH",
              "uri": "https://dev.azure.com/@{appsetting('ADO_ORGANIZATION')}/@{appsetting('ADO_PROJECT')}/_apis/wit/workitems/@{variables('WorkItemId')}?api-version=7.1",
              "headers": {
                "Content-Type": "application/json-patch+json",
                "Authorization": "Basic @{base64(concat(':', appsetting('ADO_PAT')))}"
              },
              "body": [
                {
                  "op": "add",
                  "path": "/fields/System.AssignedTo",
                  "value": "@{variables('RecipientEmail')}"
                },
                {
                  "op": "add",
                  "path": "/fields/System.Tags",
                  "value": "@{variables('Tags')}"
                }
              ],
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT5S",
                "maximumInterval": "PT30S",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "VSTS ì»¤ë„¥í„° ì œì•½ ìš°íšŒ: AssignedTo/Tags ì„¤ì •"
          },
          "Update_TableStorage_Status_Complete": {
            "type": "Http",
            "runAfter": {
              "Update_ADO_WorkItem_Fields": ["Succeeded", "Failed", "Skipped"]
            },
            "inputs": {
              "method": "PUT",
              "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails(PartitionKey='@{formatDateTime(utcNow(), 'yyyy-MM')}',RowKey='@{encodeURIComponent(variables('MessageId'))}')",
              "headers": {
                "Content-Type": "application/json",
                "Accept": "application/json;odata=nometadata",
                "x-ms-version": "2020-12-06",
                "If-Match": "*"
              },
              "body": {
                "PartitionKey": "@{formatDateTime(utcNow(), 'yyyy-MM')}",
                "RowKey": "@{variables('MessageId')}",
                "Subject": "@{variables('Subject')}",
                "ReceivedTimeKST": "@{variables('ReceivedTimeKST')}",
                "SenderEmail": "@{variables('SenderEmail')}",
                "ProcessedTime": "@{utcNow()}",
                "Source": "Gmail",
                "Status": "Completed",
                "WorkItemId": "@{variables('WorkItemId')}"
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://storage.azure.com/"
              },
              "retryPolicy": {
                "type": "fixed",
                "count": 2,
                "interval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "ì²˜ë¦¬ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ (Operational Excellence - ì¶”ì ì„±)"
          }
        },
        "description": "âš™ï¸ í•µì‹¬ ì²˜ë¦¬ Scope - AI ë¶„ì„ + Work Item ìƒì„±"
      },
      "Scope_Notification": {
        "type": "Scope",
        "runAfter": {
          "Scope_Core_Processing": ["Succeeded"]
        },
        "actions": {
          "Send_Teams_Notification": {
            "type": "ApiConnection",
            "runAfter": {},
            "inputs": {
              "host": {
                "connection": {
                  "referenceName": "teams"
                }
              },
              "method": "post",
              "path": "/beta/teams/@{encodeURIComponent(appsetting('TEAMS_TEAM_ID'))}/channels/@{encodeURIComponent(appsetting('TEAMS_CHANNEL_ID'))}/messages",
              "body": {
                "body": {
                  "contentType": "html",
                  "content": "<b>âœ… ìƒˆ Work Item ìƒì„±ë¨ (AI ë¶„ì„ ì™„ë£Œ)</b><br/><br/><b>ğŸ“§ ì†ŒìŠ¤:</b> Gmail<br/><b>ğŸ†” Work Item:</b> #@{variables('WorkItemId')}<br/><b>ğŸ·ï¸ íƒœê·¸:</b> @{variables('Tags')}<br/><b>ğŸ“‹ ì œëª©:</b> @{variables('Subject')}<br/><b>ğŸ‘¤ ë°œì‹ ì:</b> @{variables('SenderEmail')}<br/><b>ğŸ• ìˆ˜ì‹  ì‹œê°„:</b> @{variables('ReceivedTimeKST')}<br/><b>ğŸ‘¥ ë‹´ë‹¹ì:</b> @{variables('RecipientEmail')}<br/><br/><b>ğŸ¤– AI ìš”ì•½:</b><br/>@{replace(variables('AIAnalysisResult'), '\n', '<br/>')}<br/><br/><a href='https://dev.azure.com/@{appsetting('ADO_ORGANIZATION')}/@{appsetting('ADO_PROJECT')}/_workitems/edit/@{variables('WorkItemId')}'>Work Item #@{variables('WorkItemId')} ë³´ê¸°</a>"
                }
              },
              "retryPolicy": {
                "type": "fixed",
                "count": 2,
                "interval": "PT10S"
              }
            },
            "description": "Teams ì±„ë„ ì•Œë¦¼ ì „ì†¡"
          }
        },
        "description": "ğŸ“¢ ì•Œë¦¼ Scope - Teams í†µì§€"
      },
      "Scope_Error_Handler": {
        "type": "Scope",
        "runAfter": {
          "Scope_Core_Processing": ["Failed", "TimedOut"]
        },
        "actions": {
          "Set_Error_Message": {
            "type": "SetVariable",
            "runAfter": {},
            "inputs": {
              "name": "ErrorMessage",
              "value": "@{coalesce(result('Scope_Core_Processing')?[0]?['error']?['message'], 'Unknown error occurred')}"
            },
            "description": "ì—ëŸ¬ ë©”ì‹œì§€ ìº¡ì²˜"
          },
          "Log_Error_Details": {
            "type": "Compose",
            "runAfter": {
              "Set_Error_Message": ["Succeeded"]
            },
            "inputs": {
              "event": "WorkflowError",
              "severity": "Error",
              "messageId": "@variables('MessageId')",
              "subject": "@variables('Subject')",
              "senderEmail": "@variables('SenderEmail')",
              "errorMessage": "@variables('ErrorMessage')",
              "scopeFailed": "Scope_Core_Processing",
              "timestamp": "@utcNow()",
              "workflowRunId": "@workflow()['run']['name']"
            },
            "description": "ì—ëŸ¬ ìƒì„¸ ë¡œê¹… (Operational Excellence - ì§„ë‹¨)"
          },
          "Update_TableStorage_Status_Failed": {
            "type": "Http",
            "runAfter": {
              "Log_Error_Details": ["Succeeded"]
            },
            "inputs": {
              "method": "PUT",
              "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails(PartitionKey='@{formatDateTime(utcNow(), 'yyyy-MM')}',RowKey='@{encodeURIComponent(variables('MessageId'))}')",
              "headers": {
                "Content-Type": "application/json",
                "Accept": "application/json;odata=nometadata",
                "x-ms-version": "2020-12-06",
                "If-Match": "*"
              },
              "body": {
                "PartitionKey": "@{formatDateTime(utcNow(), 'yyyy-MM')}",
                "RowKey": "@{variables('MessageId')}",
                "Subject": "@{variables('Subject')}",
                "ReceivedTimeKST": "@{variables('ReceivedTimeKST')}",
                "SenderEmail": "@{variables('SenderEmail')}",
                "ProcessedTime": "@{utcNow()}",
                "Source": "Gmail",
                "Status": "Failed",
                "ErrorMessage": "@{variables('ErrorMessage')}"
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://storage.azure.com/"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "ì‹¤íŒ¨ ìƒíƒœ ê¸°ë¡ (Reliability - ë³µêµ¬ ê°€ëŠ¥ì„±)"
          },
          "Send_Error_Notification_Teams": {
            "type": "ApiConnection",
            "runAfter": {
              "Update_TableStorage_Status_Failed": ["Succeeded", "Failed"]
            },
            "inputs": {
              "host": {
                "connection": {
                  "referenceName": "teams"
                }
              },
              "method": "post",
              "path": "/beta/teams/@{encodeURIComponent(appsetting('TEAMS_TEAM_ID'))}/channels/@{encodeURIComponent(appsetting('TEAMS_CHANNEL_ID'))}/messages",
              "body": {
                "body": {
                  "contentType": "html",
                  "content": "<b>âŒ ì›Œí¬í”Œë¡œìš° ì²˜ë¦¬ ì‹¤íŒ¨</b><br/><br/><b>ğŸ“§ ì†ŒìŠ¤:</b> Gmail<br/><b>ğŸ“‹ ì œëª©:</b> @{variables('Subject')}<br/><b>ğŸ‘¤ ë°œì‹ ì:</b> @{variables('SenderEmail')}<br/><b>ğŸ• ì‹œê°„:</b> @{utcNow()}<br/><br/><b>âš ï¸ ì—ëŸ¬:</b><br/><code>@{variables('ErrorMessage')}</code><br/><br/><b>ğŸ”— ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ID:</b> @{workflow()['run']['name']}<br/><br/>Azure Portalì—ì„œ ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
                }
              }
            },
            "description": "ì‹¤íŒ¨ ì•Œë¦¼ Teams ì „ì†¡"
          },
          "Terminate_With_Error": {
            "type": "Terminate",
            "runAfter": {
              "Send_Error_Notification_Teams": ["Succeeded", "Failed"]
            },
            "inputs": {
              "runStatus": "Failed",
              "runError": {
                "code": "WorkflowProcessingError",
                "message": "@{variables('ErrorMessage')}"
              }
            },
            "description": "ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì¢…ë£Œ"
          }
        },
        "description": "ğŸš¨ ì—ëŸ¬ í•¸ë“¤ëŸ¬ Scope - Reliability + Operational Excellence"
      }
    },
    "outputs": {},
    "triggers": {
      "When_a_new_email_arrives_Gmail": {
        "type": "ApiConnection",
        "recurrence": {
          "frequency": "Minute",
          "interval": 1
        },
        "inputs": {
          "host": {
            "connection": {
              "referenceName": "gmail"
            }
          },
          "method": "get",
          "path": "/Mail/OnNewEmail",
          "queries": {
            "label": "INBOX",
            "importance": "All",
            "starred": "All",
            "fetchOnlyWithAttachments": false,
            "includeAttachments": false
          }
        },
        "splitOn": "@triggerBody()?['value']",
        "description": "Gmail ë°›ì€í¸ì§€í•¨ íŠ¸ë¦¬ê±° (1ë¶„ ê°„ê²© í´ë§)"
      }
    },
    "parameters": {
      "$connections": {
        "type": "Object",
        "defaultValue": {}
      }
    }
  },
  "kind": "Stateful"
}
