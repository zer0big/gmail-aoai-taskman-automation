{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "2.3.0.0",
    "actions": {
      "Initialize_MessageId": {
        "type": "InitializeVariable",
        "runAfter": {},
        "inputs": {
          "variables": [
            {
              "name": "MessageId",
              "type": "string",
              "value": "@{coalesce(triggerBody()?['messageId'], guid())}"
            }
          ]
        },
        "description": "Gmail Message ID ì¶”ì¶œ"
      },
      "Initialize_Subject": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_MessageId": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Subject",
              "type": "string",
              "value": "@{coalesce(triggerBody()?['subject'], '(ì œëª© ì—†ìŒ)')}"
            }
          ]
        },
        "description": "ì´ë©”ì¼ ì œëª© ì¶”ì¶œ"
      },
      "Initialize_Body": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Subject": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Body",
              "type": "string",
              "value": "@{coalesce(triggerBody()?['body'], '(ë³¸ë¬¸ ì—†ìŒ)')}"
            }
          ]
        },
        "description": "ì´ë©”ì¼ ë³¸ë¬¸ ì¶”ì¶œ"
      },
      "Initialize_ReceivedTimeKST": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Body": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "ReceivedTimeKST",
              "type": "string",
              "value": "@{addHours(coalesce(triggerBody()?['receivedTime'], utcNow()), 9)}"
            }
          ]
        },
        "description": "ìˆ˜ì‹  ì‹œê°„ KST ë³€í™˜"
      },
      "Initialize_SenderEmail": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_ReceivedTimeKST": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "SenderEmail",
              "type": "string",
              "value": "@{coalesce(triggerBody()?['from'], 'unknown@unknown.com')}"
            }
          ]
        },
        "description": "ë°œì‹ ì ì´ë©”ì¼ ì¶”ì¶œ"
      },
      "Initialize_RecipientEmail": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_SenderEmail": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "RecipientEmail",
              "type": "string",
              "value": "@{coalesce(triggerBody()?['to'], '')}"
            }
          ]
        },
        "description": "ìˆ˜ì‹ ì ì´ë©”ì¼"
      },
      "Initialize_AIAnalysisResult": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_RecipientEmail": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "AIAnalysisResult",
              "type": "string",
              "value": ""
            }
          ]
        },
        "description": "AI ë¶„ì„ ê²°ê³¼ ì €ì¥ìš©"
      },
      "Initialize_Tags": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_AIAnalysisResult": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Tags",
              "type": "string",
              "value": "Email2ADO; Gmail; HTTP"
            }
          ]
        },
        "description": "Work Item íƒœê·¸"
      },
      "Initialize_WorkItemId": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Tags": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "WorkItemId",
              "type": "integer",
              "value": 0
            }
          ]
        },
        "description": "ìƒì„±ëœ Work Item ID"
      },
      "Initialize_ErrorMessage": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_WorkItemId": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "ErrorMessage",
              "type": "string",
              "value": ""
            }
          ]
        },
        "description": "ì—ëŸ¬ ë©”ì‹œì§€ ì €ì¥ìš©"
      },
      "Scope_Duplicate_Check": {
        "type": "Scope",
        "runAfter": {
          "Initialize_ErrorMessage": ["Succeeded"]
        },
        "actions": {
          "Check_MessageId_In_TableStorage": {
            "type": "Http",
            "runAfter": {},
            "inputs": {
              "method": "GET",
              "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails(PartitionKey='@{formatDateTime(utcNow(), 'yyyy-MM')}',RowKey='@{encodeURIComponent(variables('MessageId'))}')",
              "headers": {
                "x-ms-version": "2020-12-06",
                "Accept": "application/json;odata=nometadata"
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://storage.azure.com/"
              },
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT5S",
                "maximumInterval": "PT30S",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "Table Storageì—ì„œ ì¤‘ë³µ ë©”ì¼ í™•ì¸"
          },
          "Condition_Is_Duplicate": {
            "type": "If",
            "runAfter": {
              "Check_MessageId_In_TableStorage": ["Succeeded", "Failed"]
            },
            "expression": {
              "and": [
                {
                  "equals": [
                    "@outputs('Check_MessageId_In_TableStorage')['statusCode']",
                    200
                  ]
                }
              ]
            },
            "actions": {
              "Response_Duplicate": {
                "type": "Response",
                "runAfter": {},
                "inputs": {
                  "statusCode": 200,
                  "headers": {
                    "Content-Type": "application/json"
                  },
                  "body": {
                    "status": "skipped",
                    "reason": "duplicate",
                    "messageId": "@variables('MessageId')"
                  }
                },
                "description": "ì¤‘ë³µ ë©”ì¼ ì‘ë‹µ"
              },
              "Terminate_Duplicate": {
                "type": "Terminate",
                "runAfter": {
                  "Response_Duplicate": ["Succeeded"]
                },
                "inputs": {
                  "runStatus": "Succeeded"
                },
                "description": "ì¤‘ë³µ ë©”ì¼ ì •ìƒ ì¢…ë£Œ"
              }
            },
            "else": {
              "actions": {}
            },
            "description": "ì¤‘ë³µ ì—¬ë¶€ ë¶„ê¸°"
          }
        },
        "description": "ğŸ” ì¤‘ë³µ ì²´í¬ Scope"
      },
      "Scope_Core_Processing": {
        "type": "Scope",
        "runAfter": {
          "Scope_Duplicate_Check": ["Succeeded"]
        },
        "actions": {
          "Insert_MessageId_To_TableStorage": {
            "type": "Http",
            "runAfter": {},
            "inputs": {
              "method": "POST",
              "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails",
              "headers": {
                "Content-Type": "application/json",
                "Accept": "application/json;odata=nometadata",
                "x-ms-version": "2020-12-06"
              },
              "body": {
                "PartitionKey": "@{formatDateTime(utcNow(), 'yyyy-MM')}",
                "RowKey": "@{variables('MessageId')}",
                "Subject": "@{variables('Subject')}",
                "ReceivedTimeKST": "@{variables('ReceivedTimeKST')}",
                "SenderEmail": "@{variables('SenderEmail')}",
                "ProcessedTime": "@{utcNow()}",
                "Source": "Gmail-HTTP",
                "Status": "Processing"
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://storage.azure.com/"
              },
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT5S",
                "maximumInterval": "PT30S",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "ë©”ì¼ ID ë“±ë¡"
          },
          "Analyze_Email_With_AI": {
            "type": "Http",
            "runAfter": {
              "Insert_MessageId_To_TableStorage": ["Succeeded"]
            },
            "inputs": {
              "method": "POST",
              "uri": "@{appsetting('AZURE_OPENAI_ENDPOINT')}openai/deployments/@{appsetting('AZURE_OPENAI_DEPLOYMENT_NAME')}/chat/completions?api-version=@{appsetting('AZURE_OPENAI_API_VERSION')}",
              "headers": {
                "Content-Type": "application/json"
              },
              "body": {
                "messages": [
                  {
                    "role": "system",
                    "content": "ë‹¹ì‹ ì€ ê¸°ì—… ì´ë©”ì¼ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìˆ˜ì‹ ëœ ì´ë©”ì¼ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:\n\n## ğŸ“œ ìš”ì•½\n(ë©”ì¼ í•µì‹¬ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½)\n\n## ğŸ’¡ ì¸ì‚¬ì´íŠ¸\n(ì´ ë©”ì¼ì´ ì˜ë¯¸í•˜ëŠ” ë°”, ì¤‘ìš”ë„, ê´€ë ¨ ë§¥ë½ ë¶„ì„)\n\n## âœ” ì•¡ì…˜ ì•„ì´í…œ\n(ìˆ˜ì‹ ìê°€ ì·¨í•´ì•¼ í•  êµ¬ì²´ì ì¸ ì¡°ì¹˜ ì‚¬í•­ì„ ë²ˆí˜¸ ëª©ë¡ìœ¼ë¡œ)\n\ní•œê¸€ë¡œ ì‘ë‹µí•˜ê³ , ê°„ê²°í•˜ë©´ì„œë„ ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”."
                  },
                  {
                    "role": "user",
                    "content": "ë‹¤ìŒ ì´ë©”ì¼ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\në°œì‹ ì: @{variables('SenderEmail')}\nì œëª©: @{variables('Subject')}\n\në³¸ë¬¸:\n@{variables('Body')}"
                  }
                ],
                "temperature": 0.3,
                "max_tokens": 1000
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://cognitiveservices.azure.com"
              },
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT5S",
                "maximumInterval": "PT30S",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "Azure OpenAI (GPT-4o) ì´ë©”ì¼ ë¶„ì„ - HTTP + MSI"
          },
          "Set_AI_Analysis_Result": {
            "type": "SetVariable",
            "runAfter": {
              "Analyze_Email_With_AI": ["Succeeded"]
            },
            "inputs": {
              "name": "AIAnalysisResult",
              "value": "@{coalesce(body('Analyze_Email_With_AI')?['choices']?[0]?['message']?['content'], '(AI ë¶„ì„ ê²°ê³¼ ì—†ìŒ)')}"
            },
            "description": "AI ë¶„ì„ ê²°ê³¼ ì €ì¥"
          },
          "Get_ADO_PAT_From_KeyVault": {
            "type": "Http",
            "runAfter": {
              "Set_AI_Analysis_Result": ["Succeeded"]
            },
            "inputs": {
              "method": "GET",
              "uri": "https://@{appsetting('KEY_VAULT_NAME')}.vault.azure.net/secrets/ado-pat?api-version=7.4",
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://vault.azure.net"
              },
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT5S",
                "maximumInterval": "PT30S",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "secureData": {
                "properties": ["outputs"]
              }
            },
            "description": "Key Vaultì—ì„œ ADO PAT ëŸ°íƒ€ì„ ì¡°íšŒ (MSI)"
          },
          "Create_ADO_WorkItem_HTTP": {
            "type": "Http",
            "runAfter": {
              "Get_ADO_PAT_From_KeyVault": ["Succeeded"]
            },
            "inputs": {
              "method": "POST",
              "uri": "https://dev.azure.com/@{appsetting('ADO_ORGANIZATION')}/@{appsetting('ADO_PROJECT')}/_apis/wit/workitems/$Issue?api-version=7.1",
              "headers": {
                "Content-Type": "application/json-patch+json",
                "Authorization": "Basic @{base64(concat(':', body('Get_ADO_PAT_From_KeyVault')?['value']))}"
              },
              "body": [
                {
                  "op": "add",
                  "path": "/fields/System.Title",
                  "value": "@{variables('Subject')}"
                },
                {
                  "op": "add",
                  "path": "/fields/System.Description",
                  "value": "<h2>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h2><div style='background-color:#f0f7ff;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #0078d4;'>@{replace(replace(variables('AIAnalysisResult'), '\n', '<br/>'), '## ', '<h4 style=\"color:#0078d4;margin-top:10px;\">')}</div><hr style='border:1px solid #ddd;margin:20px 0;'/><h2>ğŸ“§ ì›ë³¸ ë©”ì¼ ì •ë³´</h2><table style='width:100%;border-collapse:collapse;margin-bottom:15px;'><tr style='background:#f5f5f5;'><td style='padding:8px;border:1px solid #ddd;width:100px;'><strong>ë°œì‹ ì</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{variables('SenderEmail')}</td></tr><tr><td style='padding:8px;border:1px solid #ddd;'><strong>ìˆ˜ì‹ ì</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{variables('RecipientEmail')}</td></tr><tr style='background:#f5f5f5;'><td style='padding:8px;border:1px solid #ddd;'><strong>ìˆ˜ì‹  ì‹œê°„</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{formatDateTime(variables('ReceivedTimeKST'), 'yyyy-MM-dd HH:mm:ss')} (KST)</td></tr><tr><td style='padding:8px;border:1px solid #ddd;'><strong>ì†ŒìŠ¤</strong></td><td style='padding:8px;border:1px solid #ddd;'>ğŸ“§ Gmail (HTTP)</td></tr></table><h3>ğŸ“ ë³¸ë¬¸ ë‚´ìš©</h3><div style='background:#fafafa;padding:15px;border-radius:8px;border:1px solid #eee;white-space:pre-wrap;font-family:inherit;'>@{first(split(variables('Body'), '________________________________'))}</div>"
                },
                {
                  "op": "add",
                  "path": "/fields/System.Tags",
                  "value": "@{variables('Tags')}"
                }
              ],
              "retryPolicy": {
                "type": "exponential",
                "count": 3,
                "interval": "PT10S",
                "maximumInterval": "PT1M",
                "minimumInterval": "PT5S"
              }
            },
            "runtimeConfiguration": {
              "secureData": {
                "properties": ["inputs"]
              }
            },
            "description": "ADO Issue Work Item ìƒì„± (HTTP + Key Vault PAT)"
          },
          "Set_WorkItemId": {
            "type": "SetVariable",
            "runAfter": {
              "Create_ADO_WorkItem_HTTP": ["Succeeded"]
            },
            "inputs": {
              "name": "WorkItemId",
              "value": "@body('Create_ADO_WorkItem_HTTP')?['id']"
            },
            "description": "ìƒì„±ëœ Work Item ID ì €ì¥"
          },
          "Send_Teams_Notification_HTTP": {
            "type": "Http",
            "runAfter": {
              "Set_WorkItemId": ["Succeeded"]
            },
            "inputs": {
              "method": "POST",
              "uri": "@{appsetting('TEAMS_WORKFLOW_URL')}",
              "headers": {
                "Content-Type": "application/json"
              },
              "body": {
                "type": "message",
                "attachments": [
                  {
                    "contentType": "application/vnd.microsoft.card.adaptive",
                    "content": {
                      "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                      "type": "AdaptiveCard",
                      "version": "1.4",
                      "body": [
                        {
                          "type": "TextBlock",
                          "size": "Large",
                          "weight": "Bolder",
                          "text": "âœ… ìƒˆ Work Item ìƒì„±ë¨",
                          "color": "Good"
                        },
                        {
                          "type": "FactSet",
                          "facts": [
                            { "title": "ğŸ“§ ì†ŒìŠ¤", "value": "Gmail (HTTP)" },
                            { "title": "ğŸ†” Work Item", "value": "#@{variables('WorkItemId')}" },
                            { "title": "ğŸ·ï¸ íƒœê·¸", "value": "@{variables('Tags')}" },
                            { "title": "ğŸ“‹ ì œëª©", "value": "@{variables('Subject')}" },
                            { "title": "ğŸ‘¤ ë°œì‹ ì", "value": "@{variables('SenderEmail')}" },
                            { "title": "ğŸ• ìˆ˜ì‹  ì‹œê°„", "value": "@{variables('ReceivedTimeKST')}" }
                          ]
                        },
                        {
                          "type": "TextBlock",
                          "text": "ğŸ¤– AI ìš”ì•½",
                          "weight": "Bolder",
                          "spacing": "Medium"
                        },
                        {
                          "type": "TextBlock",
                          "text": "@{take(variables('AIAnalysisResult'), 500)}",
                          "wrap": true
                        }
                      ],
                      "actions": [
                        {
                          "type": "Action.OpenUrl",
                          "title": "Work Item ë³´ê¸°",
                          "url": "https://dev.azure.com/@{appsetting('ADO_ORGANIZATION')}/@{appsetting('ADO_PROJECT')}/_workitems/edit/@{variables('WorkItemId')}"
                        }
                      ]
                    }
                  }
                ]
              },
              "retryPolicy": {
                "type": "fixed",
                "count": 2,
                "interval": "PT10S"
              }
            },
            "description": "Teams ì±„ë„ ì•Œë¦¼ (Power Automate Workflow)"
          },
          "Update_TableStorage_Status_Complete": {
            "type": "Http",
            "runAfter": {
              "Send_Teams_Notification_HTTP": ["Succeeded", "Failed", "Skipped"]
            },
            "inputs": {
              "method": "PUT",
              "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails(PartitionKey='@{formatDateTime(utcNow(), 'yyyy-MM')}',RowKey='@{encodeURIComponent(variables('MessageId'))}')",
              "headers": {
                "Content-Type": "application/json",
                "Accept": "application/json;odata=nometadata",
                "x-ms-version": "2020-12-06",
                "If-Match": "*"
              },
              "body": {
                "PartitionKey": "@{formatDateTime(utcNow(), 'yyyy-MM')}",
                "RowKey": "@{variables('MessageId')}",
                "Subject": "@{variables('Subject')}",
                "ReceivedTimeKST": "@{variables('ReceivedTimeKST')}",
                "SenderEmail": "@{variables('SenderEmail')}",
                "ProcessedTime": "@{utcNow()}",
                "Source": "Gmail-HTTP",
                "Status": "Completed",
                "WorkItemId": "@{variables('WorkItemId')}"
              },
              "authentication": {
                "type": "ManagedServiceIdentity",
                "audience": "https://storage.azure.com/"
              }
            },
            "runtimeConfiguration": {
              "contentTransfer": {
                "transferMode": "Chunked"
              }
            },
            "description": "ì²˜ë¦¬ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸"
          }
        },
        "description": "âš™ï¸ í•µì‹¬ ì²˜ë¦¬ Scope"
      },
      "Response_Success": {
        "type": "Response",
        "runAfter": {
          "Scope_Core_Processing": ["Succeeded"]
        },
        "inputs": {
          "statusCode": 200,
          "headers": {
            "Content-Type": "application/json"
          },
          "body": {
            "status": "success",
            "workItemId": "@variables('WorkItemId')",
            "messageId": "@variables('MessageId')"
          }
        },
        "description": "ì„±ê³µ ì‘ë‹µ"
      },
      "Scope_Error_Handler": {
        "type": "Scope",
        "runAfter": {
          "Scope_Core_Processing": ["Failed", "TimedOut"]
        },
        "actions": {
          "Set_Error_Message": {
            "type": "SetVariable",
            "runAfter": {},
            "inputs": {
              "name": "ErrorMessage",
              "value": "@{coalesce(result('Scope_Core_Processing')?[0]?['error']?['message'], 'Unknown error occurred')}"
            },
            "description": "ì—ëŸ¬ ë©”ì‹œì§€ ìº¡ì²˜"
          },
          "Response_Error": {
            "type": "Response",
            "runAfter": {
              "Set_Error_Message": ["Succeeded"]
            },
            "inputs": {
              "statusCode": 500,
              "headers": {
                "Content-Type": "application/json"
              },
              "body": {
                "status": "error",
                "error": "@variables('ErrorMessage')",
                "messageId": "@variables('MessageId')"
              }
            },
            "description": "ì—ëŸ¬ ì‘ë‹µ"
          }
        },
        "description": "ğŸš¨ ì—ëŸ¬ í•¸ë“¤ëŸ¬ Scope"
      }
    },
    "outputs": {},
    "triggers": {
      "HTTP_Trigger": {
        "type": "Request",
        "kind": "Http",
        "inputs": {
          "method": "POST",
          "schema": {
            "type": "object",
            "properties": {
              "messageId": {
                "type": "string",
                "description": "Gmail Message ID"
              },
              "subject": {
                "type": "string",
                "description": "Email subject"
              },
              "body": {
                "type": "string",
                "description": "Email body content"
              },
              "from": {
                "type": "string",
                "description": "Sender email address"
              },
              "to": {
                "type": "string",
                "description": "Recipient email address"
              },
              "receivedTime": {
                "type": "string",
                "description": "Email received time (ISO 8601)"
              }
            },
            "required": ["subject", "body", "from"]
          }
        },
        "description": "HTTP POST íŠ¸ë¦¬ê±° - Power Automateì—ì„œ í˜¸ì¶œ"
      }
    },
    "parameters": {}
  },
  "kind": "Stateful"
}
