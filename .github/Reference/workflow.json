{
  "definition": {
    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion": "1.0.0.0",
    "actions": {
      "Initialize_MessageId": {
        "type": "InitializeVariable",
        "runAfter": {},
        "inputs": {
          "variables": [
            {
              "name": "MessageId",
              "type": "string",
              "value": "@triggerBody()?['internetMessageId']"
            }
          ]
        }
      },
      "Initialize_Subject": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_MessageId": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Subject",
              "type": "string",
              "value": "@triggerBody()?['subject']"
            }
          ]
        }
      },
      "Initialize_Body": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Subject": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Body",
              "type": "string",
              "value": "@{triggerBody()?['bodyPreview']}"
            }
          ]
        }
      },
      "Initialize_ReceivedTimeKST": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_Body": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "ReceivedTimeKST",
              "type": "string",
              "value": "@{addHours(triggerBody()?['receivedDateTime'], 9)}"
            }
          ]
        }
      },
      "Initialize_SenderEmail": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_ReceivedTimeKST": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "SenderEmail",
              "type": "string",
              "value": "@triggerBody()?['from']"
            }
          ]
        }
      },
      "Initialize_RecipientEmail": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_SenderEmail": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "RecipientEmail",
              "type": "string",
              "value": "@{if(empty(triggerBody()?['ccRecipients']), coalesce(triggerBody()?['toRecipients'], ''), concat(coalesce(triggerBody()?['toRecipients'], ''), '; ', triggerBody()?['ccRecipients']))}"
            }
          ]
        }
      },
      "Initialize_AI_Analysis_Result": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_RecipientEmail": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "AIAnalysisResult",
              "type": "string",
              "value": ""
            }
          ]
        }
      },
      "Initialize_Tags": {
        "type": "InitializeVariable",
        "runAfter": {
          "Initialize_AI_Analysis_Result": ["Succeeded"]
        },
        "inputs": {
          "variables": [
            {
              "name": "Tags",
              "type": "string",
              "value": "@{if(or(contains(variables('RecipientEmail'), 'D204@tdgl.co.kr'), contains(variables('RecipientEmail'), ';'), contains(variables('RecipientEmail'), ',')), 'CM Task Manager; CM', 'CM Task Manager')}"
            }
          ]
        }
      },
      "Check_MessageId_Exists_In_TableStorage": {
        "type": "Http",
        "runAfter": {
          "Initialize_Tags": ["Succeeded"]
        },
        "inputs": {
          "method": "GET",
          "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails(PartitionKey='@{formatDateTime(utcNow(), 'yyyy-MM')}',RowKey='@{encodeURIComponent(variables('MessageId'))}')",
          "headers": {
            "x-ms-version": "2020-12-06",
            "Accept": "application/json;odata=nometadata"
          },
          "authentication": {
            "type": "ManagedServiceIdentity",
            "audience": "https://storage.azure.com/"
          }
        },
        "runtimeConfiguration": {
          "contentTransfer": {
            "transferMode": "Chunked"
          }
        }
      },
      "Condition_MessageId_Duplicate": {
        "type": "If",
        "runAfter": {
          "Check_MessageId_Exists_In_TableStorage": ["Succeeded", "Failed"]
        },
        "expression": {
          "and": [
            {
              "equals": [
                "@outputs('Check_MessageId_Exists_In_TableStorage')['statusCode']",
                200
              ]
            }
          ]
        },
        "actions": {
          "Terminate_Duplicate_Mail": {
            "type": "Terminate",
            "runAfter": {},
            "inputs": {
              "runStatus": "Succeeded"
            }
          }
        },
        "else": {
          "actions": {
            "Insert_MessageId_To_TableStorage": {
              "type": "Http",
              "runAfter": {},
              "inputs": {
                "method": "POST",
                "uri": "https://@{appsetting('STORAGE_ACCOUNT_NAME')}.table.core.windows.net/ProcessedEmails",
                "headers": {
                  "Content-Type": "application/json",
                  "Accept": "application/json;odata=nometadata",
                  "x-ms-version": "2020-12-06"
                },
                "body": {
                  "PartitionKey": "@{formatDateTime(utcNow(), 'yyyy-MM')}",
                  "RowKey": "@{variables('MessageId')}",
                  "Subject": "@{variables('Subject')}",
                  "ReceivedTimeKST": "@{variables('ReceivedTimeKST')}",
                  "SenderEmail": "@{variables('SenderEmail')}",
                  "ProcessedTime": "@{utcNow()}"
                },
                "authentication": {
                  "type": "ManagedServiceIdentity",
                  "audience": "https://storage.azure.com/"
                }
              },
              "runtimeConfiguration": {
                "contentTransfer": {
                  "transferMode": "Chunked"
                }
              }
            },
            "Analyze_Email_With_AI": {
              "type": "ServiceProvider",
              "runAfter": {
                "Insert_MessageId_To_TableStorage": ["Succeeded"]
              },
              "inputs": {
                "serviceProviderConfiguration": {
                  "connectionName": "azureOpenAI",
                  "operationId": "getChatCompletions",
                  "serviceProviderId": "/serviceProviders/openai"
                },
                "parameters": {
                  "deploymentId": "@appsetting('AZURE_OPENAI_DEPLOYMENT_NAME')",
                  "messages": [
                    {
                      "role": "system",
                      "content": "ë‹¹ì‹ ì€ ê¸°ì—… ì´ë©”ì¼ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìˆ˜ì‹ ëœ ì´ë©”ì¼ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:\n\n## ğŸ“œ ìš”ì•½\n(ë©”ì¼ í•µì‹¬ ë‚´ìš©ì„ 2-3ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½)\n\n## ğŸ’¡ ì¸ì‚¬ì´íŠ¸\n(ì´ ë©”ì¼ì´ ì˜ë¯¸í•˜ëŠ” ë°”, ì¤‘ìš”ë„, ê´€ë ¨ ë§¥ë½ ë¶„ì„)\n\n## âœ” ì•¡ì…˜ ì•„ì´í…œ\n(ìˆ˜ì‹ ìê°€ ì·¨í•´ì•¼ í•  êµ¬ì²´ì ì¸ ì¡°ì¹˜ ì‚¬í•­ì„ ë²ˆí˜¸ ëª©ë¡ìœ¼ë¡œ)\n\ní•œê¸€ë¡œ ì‘ë‹µí•˜ê³ , ê°„ê²°í•˜ë©´ì„œë„ ëª…í™•í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”."
                    },
                    {
                      "role": "user",
                      "content": "ë‹¤ìŒ ì´ë©”ì¼ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\në°œì‹ ì: @{variables('SenderEmail')}\nì œëª©: @{variables('Subject')}\n\në³¸ë¬¸:\n@{variables('Body')}"
                    }
                  ],
                  "temperature": 0.3,
                  "max_tokens": 1000
                }
              }
            },
            "Set_AI_Analysis_Result": {
              "type": "SetVariable",
              "runAfter": {
                "Analyze_Email_With_AI": ["Succeeded"]
              },
              "inputs": {
                "name": "AIAnalysisResult",
                "value": "@{body('Analyze_Email_With_AI')?['content']}"
              }
            },
            "Create_ADO_WorkItem": {
              "type": "ApiConnection",
              "runAfter": {
                "Set_AI_Analysis_Result": ["Succeeded"]
              },
              "inputs": {
                "host": {
                  "connection": {
                    "referenceName": "visualstudioteamservices"
                  }
                },
                "method": "patch",
                "path": "/@{encodeURIComponent(appsetting('ADO_PROJECT'))}/_apis/wit/workitems/$@{encodeURIComponent('Issue')}",
                "queries": {
                  "account": "@{appsetting('ADO_ORGANIZATION')}"
                },
                "body": {
                  "title": "@{variables('Subject')}",
                  "description": "<h2>ğŸ¤– AI ë¶„ì„ ê²°ê³¼</h2><div style='background-color:#f0f7ff;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #0078d4;'>@{replace(replace(variables('AIAnalysisResult'), '\n', '<br/>'), '## ', '<h4 style=\"color:#0078d4;margin-top:10px;\">')}</div><hr style='border:1px solid #ddd;margin:20px 0;'/><h2>ğŸ“§ ì›ë³¸ ë©”ì¼ ì •ë³´</h2><table style='width:100%;border-collapse:collapse;margin-bottom:15px;'><tr style='background:#f5f5f5;'><td style='padding:8px;border:1px solid #ddd;width:100px;'><strong>ë°œì‹ ì</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{variables('SenderEmail')}</td></tr><tr><td style='padding:8px;border:1px solid #ddd;'><strong>ìˆ˜ì‹ ì</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{variables('RecipientEmail')}</td></tr><tr style='background:#f5f5f5;'><td style='padding:8px;border:1px solid #ddd;'><strong>ìˆ˜ì‹  ì‹œê°„</strong></td><td style='padding:8px;border:1px solid #ddd;'>@{formatDateTime(variables('ReceivedTimeKST'), 'yyyy-MM-dd HH:mm:ss')} (KST)</td></tr></table><h3>ğŸ“ ë³¸ë¬¸ ë‚´ìš©</h3><div style='background:#fafafa;padding:15px;border-radius:8px;border:1px solid #eee;white-space:pre-wrap;font-family:inherit;'>@{first(split(variables('Body'), '________________________________'))}</div>",
                  "System.AssignedTo": "@{variables('RecipientEmail')}",
                  "System.Tags": "@{variables('Tags')}"
                }
              }
            },
            "Update_ADO_WorkItem_Fields": {
              "type": "Http",
              "runAfter": {
                "Create_ADO_WorkItem": ["Succeeded"]
              },
              "inputs": {
                "method": "PATCH",
                "uri": "https://dev.azure.com/@{appsetting('ADO_ORGANIZATION')}/@{appsetting('ADO_PROJECT')}/_apis/wit/workitems/@{body('Create_ADO_WorkItem')?['id']}?api-version=7.1",
                "headers": {
                  "Content-Type": "application/json-patch+json",
                  "Authorization": "Basic @{base64(concat(':', appsetting('ADO_PAT')))}"
                },
                "body": [
                  {
                    "op": "add",
                    "path": "/fields/System.AssignedTo",
                    "value": "@{variables('RecipientEmail')}"
                  },
                  {
                    "op": "add",
                    "path": "/fields/System.Tags",
                    "value": "@{variables('Tags')}"
                  }
                ]
              },
              "runtimeConfiguration": {
                "contentTransfer": {
                  "transferMode": "Chunked"
                }
              }
            },
            "Send_Teams_Notification": {
              "type": "ApiConnection",
              "runAfter": {
                "Update_ADO_WorkItem_Fields": ["Succeeded", "Failed", "Skipped"]
              },
              "inputs": {
                "host": {
                  "connection": {
                    "referenceName": "teams"
                  }
                },
                "method": "post",
                "path": "/beta/teams/@{encodeURIComponent(appsetting('TEAMS_TEAM_ID'))}/channels/@{encodeURIComponent(appsetting('TEAMS_CHANNEL_ID'))}/messages",
                "body": {
                  "body": {
                    "contentType": "html",
                    "content": "<b>ğŸ’¬ ìƒˆ Work Item ìƒì„±ë¨ (AI ë¶„ì„ ì™„ë£Œ)</b><br/><br/><b>ğŸ·ï¸ íƒœê·¸:</b> @{variables('Tags')}<br/><b>ì œëª©:</b> @{variables('Subject')}<br/><b>ë°œì‹ ì:</b> @{variables('SenderEmail')}<br/><b>ìˆ˜ì‹  ì‹œê°„:</b> @{variables('ReceivedTimeKST')}<br/><b>ë‹´ë‹¹ì:</b> @{variables('RecipientEmail')}<br/><br/><b>ğŸ¤– AI ìš”ì•½:</b><br/>@{replace(variables('AIAnalysisResult'), '\n', '<br/>')}<br/><br/><a href='https://dev.azure.com/@{appsetting('ADO_ORGANIZATION')}/@{appsetting('ADO_PROJECT')}/_workitems/edit/@{body('Create_ADO_WorkItem')?['id']}'>Work Item #@{body('Create_ADO_WorkItem')?['id']} ë³´ê¸°</a>"
                  }
                }
              }
            }
          }
        }
      }
    },
    "outputs": {},
    "triggers": {
      "When_a_new_email_arrives_(V3)": {
        "type": "ApiConnection",
        "recurrence": {
          "frequency": "Minute",
          "interval": 1
        },
        "inputs": {
          "host": {
            "connection": {
              "referenceName": "office365"
            }
          },
          "method": "get",
          "path": "/v3/Mail/OnNewEmail",
          "queries": {
            "folderPath": "Inbox",
            "importance": "Any",
            "fetchOnlyWithAttachment": false,
            "includeAttachments": false
          }
        },
        "splitOn": "@triggerBody()?['value']"
      }
    },
    "parameters": {
      "$connections": {
        "type": "Object",
        "defaultValue": {}
      }
    }
  },
  "kind": "Stateful"
}